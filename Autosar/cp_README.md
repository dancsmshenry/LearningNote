# Classic AUTOSAR方法论

- 指导汽车领域ECU软件开发的流程


- 通过虚拟功能总线（VFB）提供SWC之间通信的抽象描述
- 提供标准的数据交换格式：ARXML

<br/>

- SWC：功能性软件组件，一般包含某些特定的实时运行的调节算法和可运行实体
- 一个上层的应用，可以拆分为不同的SWC

<br/>

- ECU：电子控制单元，汽车专用微机控制器，也叫汽车专用单片机
  - 由微处理器（CPU）、存储器（ROM、、RAM）、输入/输出接口（I/O）、模数转换器（A/D）以及整形、驱动等大规模集成电路组成
- 为了实现ECU软件的可移植和可重用，严格区分了应用程序与基础软件；同时也提供了标准化的接口（RTE）

<br/>

- CP的软件架构有以下特点：
  - 高实时性（相比linux的抢占式系统，具有一定的实时性）

  - 基于信号通信（CAN总线；不过随着some/ip的引入，也具备了面向服务的通信的能力）
  - 任务共享地址空间（我理解就是代码都跑在一个同一个OS里面，所有大家都共用一个地址空间）
  - 静态配置&部署（生成的都是.c和.h文件）



# CAN简介

CAN (controller area network)，是指控制器局域网络，是一种能实现分布式**实时控制**的**串行**通信网络

不同于电脑的单处理器，整车内的所有ECU都包含自己的独立处理器，不同的 ECU 之间可以通过 CAN 总线进行通信



<br/>



# CAN的特点

CAN总线没有固定地址，每个节点以统一形式的ID作为标识

节点消息在未被接受时不会被淹没，而是按照优先级等待处理，数据在发送失败时会自动重发

速度相对比较慢： 低速CAN大概是125kb/s，高速CAN是50kb/s

性能稳定

CAN总线将汽车内部各电控单元之间连接成一个局域网络，实现信息共享

多主机：安全敏感的应用对通信系统的可靠性要求极高，将总线能够正常工作归结到单一节点是非常危险的，因此需要对总线的接入进行去中心化，每个节点都要有接入总线的能力

每个节点都能往总线上发送消息，通信是时间驱动的，只有当新的消息传说时，CAN总线才会忙碌(因此非常适合实时应用)寻址机制：CAN总线不设置节点的地址，而是给每个节点一个消息的标识符来区别消息

优点：当前节点不需要了解其他节点的状况，只需要关注总线上的消息（有新的需要的数据就速，没有就不管）



<br/>



# CAN的组成

**ECU节点**，CAN总线和CAN网关ECU： 电子控制单元，一个普通的家用轿车往往有28+的ECU，这些ECU共同组成了汽车电子控制系统

- 通过监控各种输入数据和汽车的运行状态，并按照预先设定好的程序处理传感器数据，最终再把各个参数下发给相关的执行单元
- 是汽车的控制核心，相当于汽车的电脑，需要包含处理器、存储器、I0接口及大规模集成电路

<br/>

**CAN总线**，采用差分信号进行传输，其物理层传输介质由两条双绞线组成，一条是CAN HIGH，一条是CAN LOW，分别代表高电平和低电平

- 当没有数据收发的时候，两条线的电平都为2.5V，称为隐性电平
- 当两条线的电压差小于0.5V时，为隐性，代表逻辑1
- 当两条线的电压差大于0.5V时，为显性，代表逻辑0
- 当受到电磁干扰的时候，会同时影响两条线的电压，但是对他们二者的差值影响不大，所以CAN总线的抗干扰能力很强
- CAN总线分为几个不同的部分： 动力总成总线，底盘控制总线，车身控制总线，娱乐系统总线和诊断控制总线

<br/>

**CAN网关**，是CAN网络的核心，负责控制整车上所有总线上各类信号的处理和转发

- CAN网关接收任何CAN总线发送过来的不同传输速率的网络信号，将这些信号按照一定标准处理后广播道整车网络中

- 比如说某个ECU订阅了某个信号，则该ECU负责解析信号并执行对应的控制处理程序(PS： 感觉CAN也是发布订阅模型，但是它不是以 以太网 为基础的......
  cbr/>



<br/>

# CAN总线的通信原理

多路载波侦听：网络上所有节点都接入在同一根总线上，且数据的发送是广播式的，网络上各人节点在发送数据的时候都需要提前检测总线上是否有数据传输，如果有数据传输，就暂时不发送数据;如果没有，就立即发送

冲突检测：节点在发送数据区的时候，需要不停的检测发送的数据，确定是否与其他节点数据发送冲突，高的报文先发送

非破坏性仲裁机制，通过数据ID仲裁，ID数值越小，报文优先级越高

发送低优先级报文的节点退出仲裁后，在下次总线空闲时自动重发报文，如果有冲突，则保证优先级

高优先级的报文不能终端低优先级报文的发送
<br/>
CAN控制器具有根据ID过滤报文的功能，即只接受某些ID的报文，节点会对接受到的报文进行过滤



can总线的数据传输

- can总线的数据传输原理
  - 一个用户（控制单元）向网络中“说出”数据，而其他用户“收听”到这些数据。
  - 一些控制单元认为这些数据对它有用，它就接收并且应用这些数据，而其他控制单元也许不会理会这些数据
- 也就是说数据总线中，数据的传输是没有指定的接受者，每个单元都需要接受所有的数据
- 网上说的数据传输的五个步骤：
  - 提供数据控制单元向CAN控制器提供数据用于传输
  - 发出数据CAN收发器从CAN控制器处接收数据，将其转化为电信号发出。这些数据以数据列的形式进行传输，数据列是由一长串二进制（高电平与低电平）数字组成的
  - 接收数据所有与CAN数据总线一起构成网络的控制单元成为接收器
  - 检查数据控制单元对接收到的数据进行检查，看是否是其功能所需
  - 认可数据如果所接收的数据是重要的，它将被认可及处理，反之将被忽略
- 所以，SOA服务通信最大的特点就是以太网
  - 因为每个用户在以太网中都有自己的身份（服务地址+端口），那么数据只需要传达给指定的人，而不用每个用户都将数据接受处理