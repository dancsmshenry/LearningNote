13.2 TCP连接的建立与终止

- 三次握手
  - 主动开启者发送一个SYN报文段，并指明自己想要连接的端口号和它的客户端初始序列号
  - 服务器也发送自己的SYN报文段作为响应，并包含了它自己的初始序列号。此外，为了确认客户端的SYN，服务器将其收到的初始序列号加一作为ACK的返回值。（因此每发送一个SYN，序列号就会自动加一）ps：如果出现丢包的现象，就会重传
  - 为了确认服务器的SYN，客户端将收到的初始序列号加一作为返回的ACK数值
- 三次握手的目的：
  - 让通信双方了解一个连接正在建立，还在于数据包的选项来承载特殊的信息，交换序列号
- 四次挥手
  - TCP协议规定通过发送一个FIN段来发起关闭操作
  - 连接的主动关闭者发送一个FIN段指明接收者希望看到的自己的当前的序列号



# 13.5 TCP状态转换

- 下图是TCP状态转换图，粗箭头表示客户端的行为，虚线箭头表示服务器的行为

- ![](TCP状态转换图.png)



- 在第二次握手的时候，如果收到了主动打开方发来的重置信息而非ACK，那么就会返回到LISTEN状态，并且等待另一个连接请求的到来



- 下图是三四次握手挥手的过程
- ![](三四次握手挥手.png)

13.5.2 TIME_WAIT 状态

- 在该状态中，TCP将会等待两倍于最大段生存期的时间，有时也被称为加倍等待
- 每个实现都必须为最大段生存期选择一个数值
- 它代表任何报文段在被丢弃前在网络中被允许存在的最长时间
  - 影响这个时间的两个因素：IP数据报拥有TTL字段和跳数限制字段
- 规定：当TCP执行一个主动关闭并发送最终的ACK时，连接必须处于TIME_WAIT状态并连续两倍于最大生存期的时间
- 原因一：因为这样能够让TCP重新发送最终的ACK以避免出现丢失的情况（即最后发送的ACK可能会超时无法到达被动关闭方，导致另一方重传了它的FIN）
- 原因二：当在2MSL的状态的时候，通信双方将该连接定义为不可重新使用（2MSL状态能够防止新的连接将前一个连接的延迟报文段解释成自身数据的状况）



13.5.3 静默时间的概念

- 背景：如果一台与处于TIME_WAIT状态侠的连接相关联的主机崩溃，然后在MSL内重新启动，那应该如何处理
- 静默时间：在崩溃或重启后TCP协议应当在创建新的连接之前等待相当于一个MSL的时间



13.5.4 FIN_WAIT_2 状态

- 只有当应用程序完成了这一关闭操作，正在关闭的TCP连接才会从FIN_WAIT_2状态转移至TIME_WAIT状态
- 防止连接进入FIN_WAIT_2这一无限等待状态：
  - 如果负责主动关闭的应用执行的是一个完全关闭操作，而不是用一个半关闭来指明它还期望接受数据，那么就会设置一个计时器
  - 如果当计时器超时时连接是空心啊的，那么TCP连接就会转移到CLOSED状态