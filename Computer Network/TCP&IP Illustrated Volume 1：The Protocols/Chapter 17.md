# 17.1 引言

- 背景：虽然一些应用进程之间没有任何数据交换，但仍然需要通过连接保持一个最小的数据流
- TCP保活机制
- 保活机制是一种在不影响数据流内容的情况下探测对方的方法，它是由一个保活计时器实现的，当计时器被激发，连接一端将发送一个保活探测报文，另一端接收报文的同时会发送一个ACK作为响应



# 17.2 描述

- 保活功能在默认情况下是关闭的，TCP连接的任何一段都可以请求打开这一功能
- 保活功能可以被设置在连接的一端、两端，或者两端都没有
- 如果在一段时间（保活时间）内连接处于非活动状态，开启保活功能的一段将向对方发送一个保活探测报文
- 如果发送端没有收到响应报文，那么经过一个提前配置好的保活时间间隔，将继续发送保活探测报文，直到发送探测报文的次数达到保活探测数，这是对方主机将被确认为不可到达，连接中断



四种状态

- 对方主机仍在工作，并且可以到达，对方的TCP响应正常，并且请求端也知道对方在正常工作，请求端将保活计时器重置（重置设定为保活时间值）；如果超时之前有应用程序通过该连接传输数据，那么计时器将再次设定为保活时间值
- 对方主机已经崩溃，包括已经关闭或者正在重新启动。这时对方的TCP将不会响应。请求端不会接收到响应报文，并在经过保活时间间隔指定的时间后超时。超时前，请求端会持续发送探测报文，一共发送保活探测数指定次数的探测报文，如果请求端没有收到任何探测报文的响应，那么它将认为对方主机已经关闭，连接也将被断开
- 客户主机崩溃并且已重启。在这种情况下，请求端会收到一个对其保活探测报文的响应，但这个响应是一个重置报文段RST，请求端将会断开连接
- 对方主机仍在工作，但是由于某些原因不能到达请求端（例如网络无法传输，而且可能使用ICMP通知也可能不通知对方这一事实）。这种情况与状态2相同，因为TCP不能区分状态2与状态4，结果是都没有收到探测报文的响应



- 变量的保活时间、保活时间间隔和保活探测数的设置通常是可以变更的



# 17.3 与TCP保活机制相关的攻击

- TCP保活报文中不包含任何用户数据，所以它最多只进行有限的加密
- 因此容易受到欺骗，可能在相当长的一段时间内，受害主机必须维护不必要的会话资源
- 另一种是获得端系统隐藏的一些星系