# ARP

作用：将ip地址转换为mac地址



ARP 是借助 ARP 请求与 ARP 响应两种类型的包确定 MAC 地址的

- 主机会通过⼴播发送 ARP 请求，这个包中包含了想要知道的 MAC 地址的主机 IP 地址
- 当同个链路中的所有设备收到 ARP 请求时，会去拆开 ARP 请求包⾥的内容，如果 ARP 请求包中的⽬标 IP 地址与⾃⼰的 IP 地址⼀致，那么这个设备就将⾃⼰的 MAC 地址塞⼊ ARP 响应包返回给主机
- 操作系统通常会把第⼀次通过 ARP 获取的 MAC 地址缓存起来，以便下次直接从缓存中找到对应 IP 地址的 MAC 地址
- 不过，MAC 地址的缓存是有⼀定期限的，超过这个期限，缓存的内容将被清除







# RARP

作用：将mac地址转换为ip地址



使用步骤

- 通常这需要架设⼀台 RARP 服务器，在这个服务器上注册设备的 MAC 地址及其 IP 地址。然后再将这个设备接入到⽹络 
- 该设备会发送⼀条「我的 MAC 地址是XXXX，请告诉我，我的IP地址应该是什么」的请求信息。 
- RARP 服务器接到这个消息后返回「MAC地址为 XXXX 的设备，IP地址为 XXXX」的信息给这个设备。 
- 最后，设备就根据从 RARP 服务器所收到的应答信息设置⾃⼰的 IP 地址







# DHCP

作用：接入网络的设备获取其在网络的ip地址



工作流程

- 客户端⾸先发起 DHCP 发现报⽂（DHCP DISCOVER） 的 IP 数据报，由于客户端没有 IP 地址，也不知道 DHCP 服务器的地址，所以使⽤的是 UDP ⼴播通信，其使⽤的⼴播⽬的地址是 255.255.255.255（端⼝ 67） 并且使⽤ 0.0.0.0（端⼝ 68） 作为源 IP 地址。DHCP 客户端将该 IP 数据报传递给链路层，链路层然后 将帧⼴播到所有的⽹络中设备。 
- DHCP 服务器收到 DHCP 发现报⽂时，⽤ DHCP 提供报⽂（DHCP OFFER） 向客户端做出响应。该报⽂仍 然使⽤ IP ⼴播地址 255.255.255.255，该报⽂信息携带服务器提供可租约的 IP 地址、⼦⽹掩码、默认⽹关、 DNS 服务器以及 IP 地址租⽤期。 
- 客户端收到⼀个或多个服务器的 DHCP 提供报⽂后，从中选择⼀个服务器，并向选中的服务器发送 DHCP 请 求报⽂（DHCP REQUEST进⾏响应，回显配置的参数。 
- 最后，服务端⽤ DHCP ACK 报⽂对 DHCP 请求报⽂进⾏响应，应答所要求的参数。
- ![](DHCP工作流程.png)



如果租约的 DHCP IP 地址快期后，客户端会向服务器发送 DHCP 请求报⽂： 

- 服务器如果同意继续租⽤，则⽤ DHCP ACK 报⽂进⾏应答，客户端就会延⻓租期。 
- 服务器如果不同意继续租⽤，则⽤ DHCP NACK 报⽂，客户端就要停⽌使⽤租约的 IP 地址。



因为使用udp广播的，为了解决DHCP服务器和客户端不在同一个局域网下，使用DHCP中继代理

- DHCP 客户端会向 DHCP 中继代理发送 DHCP 请求包，⽽ DHCP 中继代理在收到这个⼴播包以后，再以单播的形式发给 DHCP 服务器
- 服务器端收到该包以后再向 DHCP 中继代理返回应答，并由 DHCP 中继代理将此包⼴播给 DHCP 客户端







# NAT

作用：同个公司、家庭、教室内的主机对外部通信时，把私有 IP 地址转换成公有 IP 地址







# ICMP

作用：

- 全名是互联网控制报文协议
- 主要功能包括
  - 确认 IP 包是否成功送达⽬标地址
  - 报告发送过程中 IP 包被废弃的原因和改善⽹络设置等



两大类

- ⼀类是⽤于诊断的查询消息，也就是「查询报⽂类型」 
- 另⼀类是通知出错原因的错误消息，也就是「差错报⽂类型」 



报文类型

- ![](ICMP报文类型.png)



### NAPI机制

- 随着网络带宽的发展，网速越来越快，之前的中断收包模式已经无法适应目前千兆，万兆的带宽了。如果每个数据包大小等于MTU大小1460字节。当驱动以千兆网速收包时，CPU将每秒被中断91829次。在以MTU收包的情况下都会出现每秒被中断10万次的情况。过多的中断会引起一个问题，CPU一直陷入硬中断而没有时间来处理别的事情了。为了解决这个问题，内核在2.6中引入了NAPI机制。

  NAPI就是混合中断和轮询的方式来收包，当有中断来了，驱动关闭中断，通知内核收包，内核软中断轮询当前网卡，在规定时间尽可能多的收包。时间用尽或者没有数据可收，内核再次开启中断，准备下一次收包

- ⽐如，当有⽹络包到达时，⽹卡发起硬件中断，于是会执⾏⽹卡硬件中断处理函数，中断处理函数处理完需要「暂 时屏蔽中断」，然后唤醒「软中断」来轮询处理数据，直到没有新数据时才恢复中断，这样⼀次中断处理多个⽹络 包，于是就可以降低⽹卡中断带来的性能开销

- 那软中断是怎么处理⽹络包的呢？它会从 Ring Buffer 中拷⻉数据到内核 struct sk_buff 缓冲区中，从⽽可以作为⼀ 个⽹络包交给⽹络协议栈进⾏逐层处理
