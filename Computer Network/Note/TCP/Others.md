# TCP的概念

- 是面向连接，可靠的，基于字节流的传输层通信结构
  - 面向连接：一定是一对一连接
  - 可靠的：⽆论的⽹络链路中出现了怎样的链路变化，TCP 都可以保证⼀个报⽂⼀定能够到达接收端
  - 字节流：：消息是「没有边界」的，所以⽆论我们消息有多⼤都可以进⾏传输。并且消息是「有序的」







# TCP连接

- ⽤于保证可靠性和流量控制维护的某些状态信息，这些信息的组合，包括Socket、序列号和窗⼝ ⼤⼩称为连接
- 需要三个信息才能达成共识
  - Socket：由 IP 地址和端⼝号组成 
  - 序列号：⽤来解决乱序问题等 
  - 窗⼝⼤⼩：⽤来做流ᰁ控制







# 确定唯一的TCP连接

- 四元组（源地址，源端口，目的地址，目的端口）







# TCP的最大连接数是多少

- 最大连接数 = 客户端IP数 * 客户端的端口数
- 即2的48次方
- 连接数的限制
  - ⾸先主要是⽂件描述符限制，Socket 都是⽂件，所以⾸先要通过 ulimit 配置⽂件描述符的数⽬
  - 另⼀个是内存限制，每个 TCP 连接都要占⽤⼀定内存，操作系统的内存是有限的







### TCP和UDP的对比

- 连接
  - TCP 是⾯向连接的传输层协议，传输数据前先要建⽴连接
  - UDP 是不需要连接，即刻传输数据
- 服务对象
  - TCP 是⼀对⼀的两点服务，即⼀条连接只有两个端点
  - UDP ⽀持⼀对⼀、⼀对多、多对多的交互通信
- 可靠性
  - TCP 是可靠交付数据的，数据可以⽆差错、不丢失、不᯿复、按需到达
  - UDP 是尽最⼤努⼒交付，不保证可靠交付数据
- 拥塞控制、流量控制
  - TCP 有拥塞控制和流ᰁ控制机制，保证数据传输的安全性
  - UDP 则没有，即使⽹络⾮常拥堵了，也不会影响 UDP 的发送速率
- ⾸部开销
  - TCP ⾸部⻓度较⻓，会有⼀定的开销，⾸部在没有使⽤「选项」字段时是 20 个字节，如果使⽤了「选项」 字段则会变⻓的。 
  - UDP ⾸部只有 8 个字节，并且是固定不变的，开销较⼩
- 传输⽅式
  - TCP 是流式传输，没有边界，但保证顺序和可靠
  - UDP 是⼀个包⼀个包的发送，是有边界的，但可能会丢包和乱序
- 分⽚不同 
  - TCP 的数据⼤⼩如果⼤于 MSS ⼤⼩，则会在**传输层**进⾏分⽚，⽬标主机收到后，也同样在传输层组装 TCP 数据包，如果中途丢失了⼀个分⽚，只需要传输丢失的这个分⽚
  - UDP 的数据⼤⼩如果⼤于 MTU ⼤⼩，则会在 **IP 层**进⾏分⽚，⽬标主机收到后，在 IP 层组装完数据，接着 再传给传输层，但是如果中途丢了⼀个分⽚，在实现可靠传输的 UDP 时则就需要᯿传所有的数据包，这样 传输效率⾮常差，所以通常 UDP 的报⽂应该⼩于 MTU







### 为什么客户端和服务端的初始序列号 ISN 是不相同的

- 如果⼀个已经失效的连接被重⽤了，但是该旧连接的历史报⽂还残留在⽹络中，如果序列号相同，那么就⽆法分辨出该报⽂是不是历史报⽂，如果历史报⽂被新的连接接收了，则会产⽣数据错乱







### 为啥IP层已经分片数据了，TCP还要分片数据

- ![](F:\Code\LearningNote\Computer Network\Note\TCP\image\MTU和MSS.png)
- （MTU和MSS的关系）
- 如果TCP不分片数据的话，那么如果一个IP分片丢失，整个IP报文的所有分片都得重传（因为IP层没有超时重传等recovery的操作）
- 所以，为了达到最佳的传输效能 TCP 协议在建⽴连接的时候通常要协商双⽅的 MSS 值，当 TCP 层发现数据超过 MSS 时，则就先会进⾏分⽚，当然由它形成的 IP 包的⻓度也就不会⼤于 MTU ，⾃然也就不⽤ IP 分片了