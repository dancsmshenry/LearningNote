# 为什么有了mac地址，还有ip地址？

- 在网络比较小的时候，我们可以用一个交换机记录网络内所有的主机的mac地址，发送数据的时候直接发给交换机，通过地址的映射，再将数据传给目的主机即可
- 而随着网络的越来越大，一个事实就是单个交换机可能无法存储这个大的地址映射，因为需要借助路由器
  - 局域网内交换机的数据传给路由器，路由器管理交换机集群，将数据分发给对应交换机
- 可问题是，路由器如何对交换机的地址进行映射转发呢？
  - 首先是，如果这样操作，会有海量的mac地址需要被记录，路由器根本装不下这么多的数据（**P1**）
  - 其次，mac地址都是被刻录在网卡上，是无法改变的，即没有归一的方法对其进行管理
  - 最后，如果主机换一个路由器进入网络，那么mac的修改就是牵一发而动全身，时空上都难以忍受
- 所以，为了能够归一化的管理设备，采用ip地址（ip以及内外网）对设备进行分配
  - 简言之，将数据直接发给路由器，接着让路由器帮我转发（**P2**）



另一种思路

- 当年设计出 IP 地址这个东西，就是因为随着网络中的设备逐渐增多，人们发现路由（也就是寻找数据包从发送方到接收方的路径）变得越来越困难了。于是人们想了一个办法，就是把网络划分成很多个子网。这样，在路由的时候，路由器可以把其他子网看成一个整体来进行计算。对于目的地在其他子网的数据包，路由器只需要让数据包到达那个子网即可，而剩下的工作就由子网内部解决了。**虽然这种方法只能让寻找到的路径接近最优而不保证最优，不过它大大减少了路由器的计算量，利大于弊，所以被采用了**



既然 IP 地址不能去掉，那么能不能去掉 MAC 地址？

- 也不能。因为 IP 地址是要设备上线以后，才能根据他进入了哪个子网来分配的，**而在设备还没有 IP 地址的时候（或者分配 IP 地址的过程中），我们还需要用 MAC 地址来区分不同的设备**
- 另一方面，链路层数据的传输就要依靠mac地址的



- **P1**：路由器需要记住每个 MAC 地址所在的子网是哪一个（不然每一次收到数据包的时候路由器都要重新满世界地去找这个 MAC 地址的位置）。而世界上有248个 MAC 地址，这就意味着即使我们给每个 MAC 地址只留 1 字节的储存空间，每个路由器也需要 256 TB 的内存！这显然是不可能实现的
- **P2**： MAC 不同的是，IP 地址是和地域相关的。对于位于同一个子网上的设备，我们给他们分配的 IP 地址前缀都是一样的。这个前缀就像邮政编码一样。这样，路由器过 IP 地址的前缀就能知道这个设备在哪个子网上了。现在，路由器只需要记住每个子网的位置即可，大大减少了路由器所需要的内存



- 参考：https://www.zhihu.com/question/21546408
- 我的一个理解：
  - **mac地址是无法改变且没有规律，不方便管理，因此需要更高层的抽象（ip地址）进行管理（子网，内外网）**
  - **ip地址的作用，其实是为了更好的管理网络环境（mac地址不变且不方便管理，因此需要一个统一的方法对网络进行管理），mac地址是为了能在设备和设备之间进行传输**







# 数据是如何在网络中传输的？

背景

- 内网：一般说的是局域网
- 外网：
  - 局域网通过一台服务器或是一个路由器对外连接的网络，这个IP地址是惟一的
  - 也就是说内网里所有的计算机都是连接到这一个外网IP上，通过这一个外网IP对外进行交换数据的
  - 一个局域网里所有电脑的内网IP是互不相同的,但共用一个外网IP
  - 用ipconfig/all查到的IP是你本机的内网IP
  - 在www.ip138.com上看到的是你连接互联网所使用的IP，即外网ip
- 端口映射是 NAT 的一种，它将外网主机的 IP 地址的一个端口（可以认为是该局域网对外的ip地址）  映射到内网中一台机器，提供相应的服务。当用户访问该 IP 的这个端口时，服务器自动将请求映射到对应局域网内部的机器上
  - 简言之：就是将内网的机器映射为对外ip的一个端口号，那么我们的内网机器对外访问的时候，表现就是当前外网ip的端口





主机 -> 路由器（或主机）

- 主机都是将数据传给默认网关（一个在主机上设置好了的ip地址；主机进入网络后通过DHCP将设置默认网关；通过ARP找到对应mac地址）
- 而这个默认网关是路由器，还是主机，都无所谓，只要是个有mac地址的就行了
  - 如果是主机收到数据，该主机就又会发给它对应的默认网关



路由器 -> 路由器（交换机）

- 将源 IP 与目的 IP 分别同这个子网掩码进行**与运算，相等则是在一个子网，不相等就是在不同子网**

- 如果源 IP 与目的 IP 处于一个子网，直接将包通过交换机发出去
- 如果源 IP 与目的 IP 不处于一个子网，就交给路由器去处理
  - 通过路由器上的路由表（通过路由算法计算得到的），判断要将数据传给那一个ip或子网




内网间的数据传输

- 在整个内网中跨子网访问的过程中，链路层的数据帧源mac和目的mac是一直变化的
- 在整个内网中跨子网访问的过程中，网络层的ip数据包源ip和目的ip是一直不变的
  - 其实跨子网的过程源ip是可以修改的，这取决于我们是否开启了NAT转换，如果开了的话就会改变源ip
  - 但目的ip是不能变的



跨网段间的数据传输

- 在整个跨域访问外网的过程中，链路层的数据帧源mac和目的mac是一直变化的
- 在整个跨域访问外网的过程中，网络层的ip数据包目的ip是一直不变的
  - 而在顶级路由器处需要把源ip转为公网ip使其可以正常上网
  - 次顶级的路由器也可以修改数据包的源Ip，取决于是否开启NAT转换



再往深细化：百度是怎样知道是源ip中的哪一台主机发送的信息

- 一个事实：我们用运营商上网，得到的都是私有（局域网）ip，运营商才有真正的公网ip
- 而我们都是用私网ip去访问公网ip，公网ip是如何辨别的呢？
- 因此要引入**端口映射**



- ![](../image/内网和外网之间的通信.png)
- 内网机器A的内网地址是192.168.31.11:80，经过路由器的端口映射为10.221.0.24:8080
- 然后再在运营商处再进行一次端口映射，转化为128.0.0.1:8888



参考

- https://blog.csdn.net/yebour/article/details/103459300

- https://blog.csdn.net/u011041241/article/details/109574509







# 路由器

- 至少有两个端口：WAN 口和 LAN 口
- WAN：接外部 IP 地址用，通常指的是出口，转发来自内部 LAN 接口的 IP 数据包，这个口的 IP 是唯一的
- LAN：接内部 IP 地址用，LAN 内部是交换机
