# 柔性数组

是c99中的新特性，“这种写法不是让你声明一个结构,而是希望你声明一个指向这个结构的指针，然后用malloc()来分配足够的空间”



一些特殊的要求：

- 不能用结构进行赋值或拷贝，因为这样只能拷贝除了伸缩型数组之外的其他成员。确实要进行拷贝，应该使用memcpy()函数



- 在结构体里面想放一个动态数组，但是又不想存一个指针，就可以使用柔性数组

- ```c
  struct t1 {
    int i;
    int a[];
  }; // t1的大小是4，不是8
  ```

- 在后续给定指针的时候，可以任意扩容

- 区别：如果这里是指针而不是数组的话，那么就会导致说，我free了t1的指针，然后还得free指针a；但是是数组的话，free指针t1的时候也会顺带的free数组a

- 同时能加快访问速度，提高缓存利用率

- 也可以理解为可变数组

- 柔性数组规定只能放在最后一个位置上面，并且只能有一个



# 优点

可以省去一个指针的内存占用

并且，因为是结构体分配的内存，所以是紧密的凑在一起的，减少了cache miss（不过还是得遵守padding的原则）

同时，因为这里是以数组的形式存在的（而不是指针形式的），所以内存上的释放就不需要再次去释放一遍其中的内容



# 缺点

可能会导致cache命中率下降，从而影响性能

- 考虑有个数组，存放n个person的指针，每个person的intor都很长
- 现在有个需求：将数组里的每个person的age都加一。此时效率会很低，因为intro太长，所以cache命中率变低了
- 如果不采用这种长度为0的数组的做法，把这些person都分配到相邻的内存上，cache命中率就会高，性能就会好一些



# reference

- https://www.jb51.net/article/224935.htm
- https://www.bilibili.com/video/BV1pT4y1Y746
- https://blog.xwyam.tech:1729/index.php/archives/82/