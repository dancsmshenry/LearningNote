# 定义

- 内联函数以代码为代价，省去函数调用的开销来提高效率





# 与宏的区别

- 在使用时，宏只做简单字符串替换（编译前）。而内联函数可以进行参数类型检查（编译时），且具有返回值
- 内联函数在编译时直接将函数代码嵌入到目标代码中，省去函数调用的开销来提高执行效率，并且进行参数类型检查，具有返回值，可以实现重载
- 宏定义时要注意书写（参数要括起来）否则容易出现歧义，内联函数不会产生歧义
- 内联函数有类型检测、语法判断等功能，而宏没有





# 为什么不把所有的函数都写成inline函数

- 每一处内联函数的调用都要复制代码，消耗更多的内存空间，因此以下情况不宜使用内联函数
  - 函数体内的代码比较长，将导致内存消耗变多
- 如果内联函数体内代码执行时间相比函数调用开销较大，则没有意义
  - 函数体内有循环，函数执行时间要比函数调用开销大





# 其他作用

背景

- 需要理解代码编译后都有哪些实体
  - 没被内联的函数是实体，你编译时如果要求输出汇编文件，你打开这个文件会发现能找到这个函数
  - 内联掉的函数，则不是实体，在汇编中找不到它
  - 模板不是实体，用到时被实例化了才可能产生实体
  - 宏函数一般就不是实体，它在预编译时被展开了
  - 类申明一般不是实体，在类内定义的方法一般是相当于有默认的 inline 关键字修饰的，所以不是实体
- 而不是实体的cpp成员都可以写入头文件中，被多个源文件包含，这些源文件分别编译，最后链接时，重复的二进制实体只保留一份
- 普通函数受历史包袱的影响，是不允许链接时有多个具有相同签名的实体出现的，否则链接时会报链接歧义错误，因为链接器不知道要保留哪个版本的实体
- 链接器会从中随机挑一个，其余舍弃
- 解决多个重复实体的方法
  - 使用 inline 标记一个函数时，允许编译单元中有相同签名的实体，最后链接时只保留一个。这样你就可以将函数的实现写在头文件里，而不用担心冲突





inline函数

- 若一个非static函数在多个编译单元重被重复定义，那么在链接阶段会发生链接错误的情况（因为面对统一符号的多个定义，链接器不知道要使用哪一个）
- 若一个头文件被多次的include，也会发生链接错误
- 上述的解决办法：在函数的声明处加上inline修饰（这样编译器在处理该函数就会认为它是一个弱符号，链接器在面对多个名字相同的弱符号时只会保留其中一个定义（具体保留规则视编译器而定））
- 当然，没有规定强制多个编译单元中的同名inline函数的定义必须一致，链接器并不会对这种定义不一致的行为报错，但你却无法保证生成的可执行文件中调用了哪个版本
  - 所以面对这种其他编译单元可能定义了同名inline函数的情况，不要轻易定义该名字的inline函数
  - 因为你既无法保证对方的定义与你相同，也无法保证链接器最终选择的定义
  - 如果非要定义，应该将其声明为static或者将其声明定义在另一个不冲突的命名空间中
  - 当然，不使用任何关键字修饰该函数也不行，因为这时你定义的版本对应的符号是全局的强符号，链接器在面对多个弱符号和一个强符号时一定会采用强符号对应的定义，因此你定义的版本会覆盖其它单元所定义的inline版本



inline变量

- inline用于修饰变量定义是在cpp17的事情了，允许在多个编译单元对同一个变量进行定义，并且在链接时只保留其中的一份作为该符号的定义
- 同时在多个源文件中定义同一个inline变量必须保证它们的定义都相同，否则和inline函数一样，你没办法保证链接器最终采用的是哪个定义
- inline变量除了允许我们在头文件中定义全局变量，也允许我们在类定义中直接初始化静态数据成员



inline命名空间

- 对于一个用inline修饰的内嵌命名空间而言，它所包含的成员在可见性上如同声明在外围命名空间中一样
- inline命名空间最主要的用途是为**程序库的版本控制提供语言上的支持**
- 一般来说库的作者会为不同的版本放置到专属的命名空间，再用一个与版本无关的外围命名空间将它们包含，并通过预编译指令选择性地将开发环境支持的库版本对应的命名空间暴露给用户
- （就是通过if endif和inline实现的吧）





# 经验

- 不要把全局变量以及全局函数的定义放在头文件里面，这样编译的即使加上了#ifndef都不行，要加上inline才可以





# 参考

- https://www.zhihu.com/question/24185638/answer/2404153835
- https://www.zhihu.com/question/311420548/answer/592941203
- https://www.zhihu.com/question/419304773/answer/1453712022