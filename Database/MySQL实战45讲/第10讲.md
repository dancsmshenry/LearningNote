# MySQL为什么有时候会选错索引？

- mysql选择索引是根据优化器来判断的



### 优化器的逻辑

- 优化器选择索引的目的，是找到一个最优的执行方案，并用最小的代价去执行语句
- 优化器的判断标准有：扫描行数（扫描的行数越少，访问磁盘数据的次数越少），还会结合是否使用临时表、是否排序等因素进行判断



优化器判断扫描行数

- MySQL 在真正开始执行语句之前，并不能精确地知道满足这个条件的记录有多少条，而只能根据统计信息来估算记录数
- 统计信息就是索引的区分度，一个索引上不同的值越多，这个索引的区分度就越好，而一个索引上不同的值的个数，我们称为基数
- 即基数越大，索引的区分度越好



获取基数的方法

- 采样统计
- 采样统计的时候，InnoDB 默认会选择 N 个数据页，统计这些页面上的不同值，得到一个平均值
- 然后乘以这个索引的页面数，就得到了这个索引的基数
- PS：而数据表是会持续更新的，索引统计信息也不会固定不变。所以，当变更的数据行数超过 1/M 的时候，会自动触发重新做一次索引统计



- 其实采样统计很容易不准的，但这不是优化器的全部
- 索引统计只是一个输入，对于一个具体的语句来说，优化器还要判断，执行这个语句本身要扫描多少行
- 优化器会估量每种索引的区别，而从结果上来看，优化器认为直接扫描主键索引更快，而从执行时间看来，这个选择却不是最优的





### 索引选择异常和处理

- 采用force index强行选择一个索引
  - 不优雅
  - 如果索引改了名字，语法上很麻烦
- 考虑修改语句，引导MySQL使用我们期待的索引
- 在有些场合下，创建一个更合适的索引，来提供给优化器做选择，或删掉适用的索引